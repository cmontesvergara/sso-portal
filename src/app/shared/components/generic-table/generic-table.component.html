<!-- Header with Search and Title -->
<div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div class="inline-block">
        <h3 class="font-semibold text-foreground" *ngIf="title">{{ title }}</h3>
        <div class="space-x-1 text-xs font-medium text-muted-foreground" *ngIf="subtitle || totalItems > 0">
            <span *ngIf="subtitle">{{ subtitle }}: </span>
            <span class="text-foreground">{{ totalItems }} registros</span>
        </div>
    </div>
    <div class="inline-block w-full md:w-auto">
        <div class="flex flex-wrap gap-2 items-center">
            <!-- Custom Actions -->
            <ng-container *ngIf="headerActions">
                <ng-container *ngTemplateOutlet="headerActions"></ng-container>
            </ng-container>

            <div class="flex w-full md:w-auto">
                <label class="relative text-muted-foreground w-full">
                    <div class="absolute left-2.5 top-2.5">
                        <svg-icon src="./assets/icons/heroicons/outline/magnifying-glass.svg" [svgClass]="'h-4 w-4'">
                        </svg-icon>
                    </div>
                    <input name="search"
                        class="py-2 pl-8 pr-2 w-full md:w-64 border rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary-500"
                        placeholder="Buscar..." type="text" [(ngModel)]="searchTerm" (input)="onSearchChange()" />
                </label>
            </div>
        </div>
    </div>
</div>

<div class="flex min-w-full flex-col rounded-xl border border-muted/20 bg-background p-2">
    <div
        class="scrollbar-thumb-rounded scrollbar-track-rounded grow overflow-x-auto scrollbar-thin scrollbar-track-transparent scrollbar-thumb-muted">
        <table
            class="table w-full table-auto border-collapse border-0 text-left align-middle leading-5 text-muted-foreground">
            <thead class="border border-muted/20 text-xs text-muted-foreground">
                <tr>
                    <th *ngFor="let col of columns" [style.width]="col.width" class="whitespace-nowrap">
                        {{ col.header }}
                    </th>
                </tr>
            </thead>
            <tbody>
                <!-- Loading State -->
                <tr *ngIf="loading">
                    <td [attr.colspan]="columns.length" class="py-12 text-center text-sm">
                        <div class="flex justify-center items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                        </div>
                    </td>
                </tr>

                <!-- Data Rows -->
                <ng-container *ngIf="!loading">
                    <tr *ngFor="let row of paginatedData; let i = index; let last = last"
                        class="hover:bg-card/50 transition-colors">
                        <td *ngFor="let col of columns">
                            <ng-container [ngSwitch]="col.type">
                                <!-- Actions Column Type -->
                                <ng-container *ngSwitchCase="'actions'">
                                    <div class="relative flex justify-end pr-4">
                                        <button (click)="toggleActionMenu(row, $event)" cdkOverlayOrigin
                                            #trigger="cdkOverlayOrigin"
                                            class="flex h-7 w-7 items-center justify-center rounded-md text-muted-foreground hover:bg-gray-100 hover:text-foreground transition">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </button>

                                        <!-- Dropdown Menu with CDK Overlay -->
                                        <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="trigger"
                                            [cdkConnectedOverlayOpen]="isMenuOpen(row)"
                                            [cdkConnectedOverlayHasBackdrop]="true" (backdropClick)="closeActionMenu()"
                                            [cdkConnectedOverlayPositions]="[
                                                {originX: 'end', originY: 'bottom', overlayX: 'end', overlayY: 'top'},
                                                {originX: 'end', originY: 'top', overlayX: 'end', overlayY: 'bottom'}
                                            ]">
                                            <div
                                                class="w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                                                <div class="py-1" role="menu" aria-orientation="vertical">
                                                    <ng-container
                                                        *ngTemplateOutlet="col.template!; context: { $implicit: row, close: closeActionMenu.bind(this) }">
                                                    </ng-container>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </div>
                                </ng-container>

                                <!-- Custom/Default -->
                                <ng-container *ngSwitchDefault>
                                    <ng-container *ngIf="col.template; else defaultCell">
                                        <ng-container *ngTemplateOutlet="col.template; context: { $implicit: row }">
                                        </ng-container>
                                    </ng-container>
                                    <ng-template #defaultCell>
                                        {{ col.field ? row[col.field] : '-' }}
                                    </ng-template>
                                </ng-container>
                            </ng-container>
                        </td>
                    </tr>

                    <!-- Empty State -->
                    <tr *ngIf="paginatedData.length === 0">
                        <td [attr.colspan]="columns.length" class="py-12 text-center text-sm text-gray-500">
                            No se encontraron registros
                        </td>
                    </tr>
                </ng-container>
            </tbody>
        </table>
    </div>

    <!-- Footer / Pagination -->
    <div class="flex flex-wrap items-center justify-between gap-2 py-3 px-2 text-xs text-muted-foreground border-t border-muted/20 mt-2"
        *ngIf="!loading && totalItems > 0">
        <div class="order-2 flex items-center gap-2 md:order-1">
            Mostrar
            <select class="p-1 border rounded" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
            </select>
            por p√°gina
        </div>

        <div class="order-1 flex items-center gap-4 md:order-2">
            <span>{{ startItemIndex }}-{{ endItemIndex }} de {{ totalItems }}</span>
            <div class="inline-flex items-center gap-1">
                <button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1"
                    class="inline-flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-md text-sm disabled:opacity-50 hover:bg-gray-100 disabled:hover:bg-transparent transition-colors">
                    <svg-icon src="./assets/icons/heroicons/outline/arrow-long-left.svg" [svgClass]="'h-4 w-4'">
                    </svg-icon>
                </button>

                <ng-container *ngFor="let page of pagesArray">
                    <button (click)="onPageChange(page)" [class.bg-primary-100]="page === currentPage"
                        [class.text-primary-700]="page === currentPage"
                        class="inline-flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-md text-sm hover:bg-gray-100 transition-colors">
                        {{ page }}
                    </button>
                </ng-container>

                <button (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages"
                    class="inline-flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-md text-sm disabled:opacity-50 hover:bg-gray-100 disabled:hover:bg-transparent transition-colors">
                    <svg-icon src="./assets/icons/heroicons/outline/arrow-long-right.svg" [svgClass]="'h-4 w-4'">
                    </svg-icon>
                </button>
            </div>
        </div>
    </div>
</div>